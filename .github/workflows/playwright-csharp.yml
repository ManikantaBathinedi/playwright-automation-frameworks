name: Playwright C# Tests

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:  # Manual trigger

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  test:
    name: Test on ${{ matrix.os }} - ${{ matrix.browser }}
    timeout-minutes: 60
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        browser: [chromium, firefox, webkit]
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ðŸ“¦ Restore dependencies
      run: dotnet restore csharp-playwright-framework/csharp-playwright-framework/PlaywrightFramework/PlaywrightFramework.csproj

    - name: ðŸ”¨ Build project
      run: dotnet build csharp-playwright-framework/csharp-playwright-framework/PlaywrightFramework/PlaywrightFramework.csproj --configuration Release --no-restore

    - name: ðŸŽ­ Install Playwright browsers
      run: pwsh csharp-playwright-framework/csharp-playwright-framework/PlaywrightFramework/bin/Release/net8.0/playwright.ps1 install --with-deps

    - name: ðŸ§ª Run tests
      env:
        BROWSER: ${{ matrix.browser }}
        TEST_ENV: qa
      run: dotnet test csharp-playwright-framework/csharp-playwright-framework/PlaywrightFramework/PlaywrightFramework.csproj --configuration Release --no-build --logger "trx;LogFileName=test-results.trx" --logger "console;verbosity=detailed"

    - name: ðŸ“Š Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.os }}-${{ matrix.browser }}
        path: |
          csharp-playwright-framework/**/TestResults/**/*.trx
          csharp-playwright-framework/**/screenshots/**
          csharp-playwright-framework/**/traces/**
          **/videos/**
        retention-days: 30

    - name: ðŸ“ˆ Publish test results
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: Test Results - ${{ matrix.os }} - ${{ matrix.browser }}
        path: 'csharp-playwright-framework/**/TestResults/*.trx'
        reporter: dotnet-trx
        fail-on-error: false

  smoke-tests:
    name: Smoke Tests (Quick Check)
    timeout-minutes: 15
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ðŸ“¦ Restore and Build
      run: |
        dotnet restore csharp-playwright-framework/PlaywrightFramework/PlaywrightFramework.csproj
        dotnet build csharp-playwright-framework/PlaywrightFramework/PlaywrightFramework.csproj --configuration Release --no-restore

    - name: ðŸŽ­ Install Playwright Chromium only
      run: pwsh csharp-playwright-framework/PlaywrightFramework/bin/Release/net8.0/playwright.ps1 install chromium --with-deps

    - name: ðŸš€ Run Smoke Tests
      env:
        TEST_ENV: qa
      run: dotnet test csharp-playwright-framework/PlaywrightFramework/PlaywrightFramework.csproj --filter "Category=Smoke" --configuration Release --no-build --logger "trx"

    - name: ðŸ“Š Upload smoke test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: smoke-test-results
        path: 'csharp-playwright-framework/**/TestResults/**'
        retention-days: 7

  security-tests:
    name: Security Tests
    timeout-minutes: 20
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ðŸ“¦ Restore and Build
      run: |
        dotnet restore csharp-playwright-framework/PlaywrightFramework/PlaywrightFramework.csproj
        dotnet build csharp-playwright-framework/PlaywrightFramework/PlaywrightFramework.csproj --configuration Release --no-restore

    - name: ðŸŽ­ Install Playwright browsers
      run: pwsh csharp-playwright-framework/PlaywrightFramework/bin/Release/net8.0/playwright.ps1 install chromium --with-deps

    - name: ðŸ”’ Run Security Tests
      env:
        TEST_ENV: qa
      run: dotnet test csharp-playwright-framework/PlaywrightFramework/PlaywrightFramework.csproj --filter "Category=Security" --configuration Release --no-build --logger "trx"

    - name: ðŸ“Š Upload security test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-test-results
        path: |
          csharp-playwright-framework/**/TestResults/**
          csharp-playwright-framework/**/screenshots/**
          csharp-playwright-framework/**/traces/**
        retention-days: 30

  regression-tests:
    name: Full Regression Suite
    timeout-minutes: 60
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ðŸ“¦ Restore and Build
      run: |
        dotnet restore csharp-playwright-framework/PlaywrightFramework/PlaywrightFramework.csproj
        dotnet build csharp-playwright-framework/PlaywrightFramework/PlaywrightFramework.csproj --configuration Release --no-restore

    - name: ðŸŽ­ Install Playwright browsers
      run: pwsh csharp-playwright-framework/PlaywrightFramework/bin/Release/net8.0/playwright.ps1 install --with-deps

    - name: ðŸ”„ Run Full Test Suite
      env:
        TEST_ENV: staging
      run: dotnet test csharp-playwright-framework/PlaywrightFramework/PlaywrightFramework.csproj --configuration Release --no-build --logger "trx;LogFileName=regression-results.trx" --logger "html;LogFileName=regression-report.html"

    - name: ðŸ“Š Upload regression results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: regression-test-results
        path: |
          csharp-playwright-framework/**/TestResults/**
          csharp-playwright-framework/**/screenshots/**
          csharp-playwright-framework/**/traces/**
          **/videos/**
          **/logs/**
        retention-days: 60

  test-summary:
    name: Test Results Summary
    if: always()
    needs: [test, smoke-tests, security-tests]
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“‹ Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: all-test-results

    - name: ðŸ“Š Display summary
      run: |
        echo "## Test Execution Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… All test jobs completed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Artifacts Generated:" >> $GITHUB_STEP_SUMMARY
        ls -R all-test-results || echo "No artifacts found" >> $GITHUB_STEP_SUMMARY

